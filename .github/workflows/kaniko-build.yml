name: Kaniko build template

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: gcr.io/kaniko-project/executor:latest
    steps:
      - uses: actions/checkout@v3

      - name: Configure Docker Client
        run: |-
          mkdir -p /kaniko/.docker
          echo "{\"auths\":{\"gcr.io\":{\"auth\":\"$(printf "%s:%s" "_json_key" "${{ secrets.GCR_SERVICE_ACCOUT_KEY }}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json

      - name: Push Docker Image to Container Registry (GCR)
        run: |-
          /kaniko/executor
          --cache=true
          --dockerfile "./Dockerfile"
          --destination "gcr.io/skael-hydra/${{ inputs.image_name }}:${GITHUB_SHA:0:8}"
